<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Signal Mapper Pro</title>
    <!-- Подключаем библиотеки -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    
    <style>
        body { overscroll-behavior-y: none; }
        .map-pin { transition: transform 0.1s; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Чтобы не вылетало контекстное меню при перемещении правой кнопкой */
        canvas, img, .map-container { -webkit-touch-callout: none; -webkit-user-select: none; }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden select-none">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        const App = () => {
            const [points, setPoints] = useState([]);
            const [selectedPointId, setSelectedPointId] = useState(null);
            const [imageState, setImageState] = useState({ src: '' });
            
            // Состояние навигации
            const [scale, setScale] = useState(1);
            const [offset, setOffset] = useState({ x: 0, y: 0 });
            const [isPanning, setIsPanning] = useState(false);
            
            const mapRef = useRef(null);
            const containerRef = useRef(null);
            const lastMousePos = useRef({ x: 0, y: 0 });

            const handleImageUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImageState({ src: e.target.result });
                        setPoints([]);
                        setScale(1);
                        setOffset({ x: 0, y: 0 });
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Зум колесиком
            const handleWheel = (e) => {
                if (!imageState.src) return;
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                setScale(prev => Math.min(Math.max(prev * delta, 0.2), 10));
            };

            // Перемещение (Правая кнопка мыши)
            const handleMouseDown = (e) => {
                if (e.button === 2 || e.button === 1) { // Правая кнопка или колесико
                    setIsPanning(true);
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                }
            };

            const handleMouseMove = (e) => {
                if (isPanning) {
                    const dx = e.clientX - lastMousePos.current.x;
                    const dy = e.clientY - lastMousePos.current.y;
                    setOffset(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                    lastMousePos.current = { x: e.clientX, y: e.clientY };
                }
            };

            const handleMouseUp = () => setIsPanning(false);

            // Клик для установки точки
            const handleMapClick = (e) => {
                if (e.button !== 0 || isPanning || !imageState.src) return;
                if (e.target.closest('.map-pin')) return;

                const rect = mapRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                const newId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 1;
                setPoints([...points, { id: newId, x, y, dbm: '' }]);
                setSelectedPointId(newId);
            };

            const handleExport = async () => {
                if (points.length === 0) return alert("Добавьте точки!");
                
                // Excel
                const ws = XLSX.utils.json_to_sheet(points.map(p => ({ "№": p.id, "Сигнал (dBm)": p.dbm || "н/д" })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "WiFi");
                XLSX.writeFile(wb, "wifi-survey.xlsx");

                // PNG
                if (mapRef.current) {
                    const dataUrl = await htmlToImage.toPng(mapRef.current);
                    const link = document.createElement('a');
                    link.download = 'wifi-map.png';
                    link.href = dataUrl;
                    link.click();
                }
            };

            return (
                <div className="flex flex-col h-screen bg-slate-100 font-sans text-slate-900" onContextMenu={(e) => e.preventDefault()}>
                    {/* Шапка */}
                    <header className="bg-white border-b h-16 flex items-center justify-between px-6 shrink-0 z-50 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                                <Icon name="wifi" />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold leading-none uppercase tracking-tight">WiFi Mapper</h1>
                                <p className="text-[10px] text-slate-400 font-bold mt-1">PRO SURVEY TOOL</p>
                            </div>
                        </div>
                        
                        {imageState.src && (
                            <button onClick={handleExport} className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition-all shadow-md font-bold text-sm">
                                <Icon name="download" size={18} />
                                <span>Экспорт отчета</span>
                            </button>
                        )}
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Область карты */}
                        <section 
                            className="flex-1 relative overflow-hidden bg-slate-200 cursor-crosshair"
                            onWheel={handleWheel}
                            onMouseDown={handleMouseDown}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onMouseLeave={handleMouseUp}
                            onClick={handleMapClick}
                        >
                            {!imageState.src ? (
                                <div className="flex items-center justify-center h-full">
                                    <div className="max-w-md w-full border-4 border-dashed border-slate-300 rounded-3xl p-12 text-center bg-white/50">
                                        <Icon name="image" size={48} className="text-slate-300 mb-4" />
                                        <h3 className="text-xl font-bold text-slate-700 mb-6">Загрузите план помещения</h3>
                                        <label className="inline-flex items-center gap-2 px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl cursor-pointer shadow-lg transition-transform hover:scale-105">
                                            <Icon name="plus" />
                                            <span>Выбрать файл</span>
                                            <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                                        </label>
                                    </div>
                                </div>
                            ) : (
                                <div 
                                    ref={mapRef}
                                    className="absolute origin-top-left transition-transform duration-75"
                                    style={{ 
                                        transform: `translate(${offset.x}px, ${offset.y}px) scale(${scale})`,
                                    }}
                                >
                                    <img 
                                        src={imageState.src} 
                                        className="block max-w-none h-auto select-none pointer-events-none shadow-2xl" 
                                        style={{ maxHeight: '85vh' }} 
                                        draggable={false} 
                                    />
                                    {points.map((point) => (
                                        <div 
                                            key={point.id} 
                                            onClick={(e) => { e.stopPropagation(); setSelectedPointId(point.id); }}
                                            className={`map-pin absolute transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center rounded-full border-2 shadow-xl cursor-pointer ${
                                                selectedPointId === point.id 
                                                ? 'w-10 h-10 bg-blue-600 border-white text-white z-30 scale-125' 
                                                : 'w-8 h-8 bg-red-500 border-white text-white z-20'
                                            }`}
                                            style={{ left: `${point.x}%`, top: `${point.y}%` }}
                                        >
                                            <span className="font-bold text-[10px]">{point.id}</span>
                                            {point.dbm && (
                                                <div className="absolute top-full mt-2 px-2 py-1 bg-slate-800 text-white text-[10px] font-bold rounded shadow-md whitespace-nowrap">
                                                    {point.dbm} dBm
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {imageState.src && (
                                <div className="absolute bottom-4 left-4 bg-white/80 backdrop-blur px-3 py-1.5 rounded-lg text-[10px] font-bold text-slate-500 shadow-sm border border-slate-200">
                                    ЛКМ: точка | ПКМ: перемещение | Колесо: зум
                                </div>
                            )}
                        </section>

                        {/* Боковая панель */}
                        {imageState.src && (
                            <aside className="w-80 bg-white border-l flex flex-col shadow-2xl z-40">
                                <div className="p-4 border-b bg-slate-50 flex items-center justify-between">
                                    <h3 className="font-bold text-slate-700">Список точек</h3>
                                    <span className="bg-blue-100 text-blue-600 px-2.5 py-0.5 rounded-full text-xs font-bold">{points.length}</span>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                    {points.length === 0 ? (
                                        <div className="text-center py-20 text-slate-300">
                                            <Icon name="mouse-pointer-2" size={32} className="mx-auto mb-2 opacity-20" />
                                            <p className="text-sm">Нажмите на план,<br/>чтобы поставить точку</p>
                                        </div>
                                    ) : (
                                        [...points].reverse().map(p => (
                                            <div 
                                                key={p.id} 
                                                onClick={() => setSelectedPointId(p.id)} 
                                                className={`p-3 rounded-xl border-2 transition-all cursor-pointer ${
                                                    selectedPointId === p.id 
                                                    ? 'border-blue-500 bg-blue-50' 
                                                    : 'border-slate-100 bg-white hover:border-slate-200'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm shrink-0 ${
                                                        selectedPointId === p.id ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'
                                                    }`}>
                                                        {p.id}
                                                    </div>
                                                    <div className="flex-1 relative">
                                                        <input 
                                                            type="number" 
                                                            value={p.dbm} 
                                                            placeholder="-65" 
                                                            autoFocus={selectedPointId === p.id}
                                                            className="w-full bg-transparent border-b-2 border-slate-200 focus:border-blue-400 outline-none font-bold text-lg pr-8" 
                                                            onChange={(e) => setPoints(points.map(pt => pt.id === p.id ? {...pt, dbm: e.target.value} : pt))} 
                                                        />
                                                        <span className="absolute right-0 bottom-1 text-[10px] text-slate-400 font-bold uppercase">dBm</span>
                                                    </div>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setPoints(points.filter(pt => pt.id !== p.id)); }} 
                                                        className="text-slate-300 hover:text-red-500 p-1"
                                                    >
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div className="p-4 border-t bg-slate-50">
                                    <button onClick={() => { if(confirm('Очистить всё?')) {setImageState({src:''}); setPoints([]);} }} className="w-full py-2 text-xs font-bold text-slate-400 hover:text-red-500 flex items-center justify-center gap-2 border border-dashed border-slate-300 rounded-lg transition-colors">
                                        <Icon name="refresh-ccw" size={14} />
                                        Очистить проект
                                    </button>
                                </div>
                            </aside>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
