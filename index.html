<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WiFi Mapper Pro | Export Fixed</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Библиотека для создания скриншота -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    
    <style>
        :root { --app-height: 100dvh; }
        body { height: var(--app-height); overflow: hidden; overscroll-behavior: none; font-family: sans-serif; }
        .app-container { height: var(--app-height); }
        .map-viewport { touch-action: none; cursor: crosshair; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        const App = () => {
            const [points, setPoints] = useState([]);
            const [image, setImage] = useState(null);
            const [selectedId, setSelectedId] = useState(null);
            const [isPanelOpen, setIsPanelOpen] = useState(false);
            
            // Навигация (Zoom & Pan)
            const [scale, setScale] = useState(1);
            const [offset, setOffset] = useState({ x: 0, y: 0 });
            const [isMoving, setIsMoving] = useState(false);
            
            const mapContainerRef = useRef(null); // Ссылка на то, ЧТО мы будем фотографировать
            const lastTouch = useRef({ x: 0, y: 0 });
            const moveThreshold = useRef(0);

            const onUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setImage(ev.target.result);
                        setPoints([]);
                        setScale(1);
                        setOffset({ x: 0, y: 0 });
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Функции перемещения
            const handleStart = (x, y) => {
                setIsMoving(true);
                lastTouch.current = { x, y };
                moveThreshold.current = 0;
            };

            const handleMove = (x, y) => {
                if (!isMoving) return;
                const dx = x - lastTouch.current.x;
                const dy = y - lastTouch.current.y;
                moveThreshold.current += Math.abs(dx) + Math.abs(dy);
                setOffset(prev => ({ x: prev.x + dx, y: prev.y + dy }));
                lastTouch.current = { x, y };
            };

            const handleEnd = (clientX, clientY) => {
                // Если мы почти не двигали экран (меньше 6px) — значит это клик, ставим точку
                if (moveThreshold.current < 6 && image && mapContainerRef.current) {
                    const rect = mapContainerRef.current.getBoundingClientRect();
                    // Вычисляем координаты клика относительно картинки с учетом текущего зума
                    const x = ((clientX - rect.left) / rect.width) * 100;
                    const y = ((clientY - rect.top) / rect.height) * 100;

                    const newId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 1;
                    setPoints([...points, { id: newId, x, y, dbm: '' }]);
                    setSelectedId(newId);
                }
                setIsMoving(false);
            };

            // ГЛАВНАЯ ФУНКЦИЯ ЭКСПОРТА (EXCEL + PHOTO)
            const handleExport = async () => {
                if (points.length === 0) return alert("Сначала добавьте точки!");

                try {
                    // 1. Экспорт в EXCEL
                    const data = points.map(p => ({ "№ Точки": p.id, "Сигнал (dBm)": p.dbm || "н/д" }));
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "WiFi Measurements");
                    XLSX.writeFile(wb, "WiFi-Survey-Report.xlsx");

                    // 2. Экспорт ФОТО (Карта с точками)
                    if (mapContainerRef.current) {
                        // Делаем небольшую паузу, чтобы UI успел обновиться
                        const dataUrl = await htmlToImage.toPng(mapContainerRef.current, {
                            backgroundColor: '#ffffff',
                            quality: 1,
                            pixelRatio: 2 // Улучшаем четкость снимка
                        });
                        
                        const link = document.createElement('a');
                        link.download = 'WiFi-Signal-Map.png';
                        link.href = dataUrl;
                        link.click();
                    }
                } catch (err) {
                    console.error("Ошибка при экспорте:", err);
                    alert("Произошла ошибка при создании фото. Попробуйте еще раз.");
                }
            };

            return (
                <div className="app-container flex flex-col bg-slate-50">
                    {/* Header */}
                    <header className="h-16 bg-white border-b flex items-center justify-between px-6 shrink-0 z-50 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                                <Icon name="wifi" size={24} />
                            </div>
                            <div className="hidden sm:block">
                                <h1 className="text-lg font-black leading-none uppercase tracking-tighter">WiFi Mapper</h1>
                                <p className="text-[10px] text-slate-400 font-bold">PROFESSIONAL REPORTING</p>
                            </div>
                        </div>

                        {image && (
                            <div className="flex items-center gap-2">
                                <button onClick={handleExport} className="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-md transition-all active:scale-95">
                                    <Icon name="download" size={18} />
                                    <span className="hidden sm:inline">Экспорт (Excel + Фото)</span>
                                </button>
                                <button onClick={() => setIsPanelOpen(!isPanelOpen)} className="p-2 bg-slate-100 text-slate-600 rounded-xl md:hidden">
                                    <Icon name={isPanelOpen ? "map" : "list"} size={24} />
                                </button>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 flex overflow-hidden relative">
                        {/* Область карты */}
                        <section 
                            className="flex-1 bg-slate-200 relative overflow-hidden map-viewport"
                            onMouseDown={(e) => { if(e.button !== 0) return; handleStart(e.clientX, e.clientY); }}
                            onMouseMove={(e) => handleMove(e.clientX, e.clientY)}
                            onMouseUp={(e) => handleEnd(e.clientX, e.clientY)}
                            onTouchStart={(e) => handleStart(e.touches[0].clientX, e.touches[0].clientY)}
                            onTouchMove={(e) => handleMove(e.touches[0].clientX, e.touches[0].clientY)}
                            onTouchEnd={(e) => {
                                const t = e.changedTouches[0];
                                handleEnd(t.clientX, t.clientY);
                            }}
                            onWheel={(e) => {
                                e.preventDefault();
                                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                                setScale(s => Math.min(Math.max(s * delta, 0.2), 10));
                            }}
                        >
                            {!image ? (
                                <div className="h-full flex flex-col items-center justify-center p-8 text-center">
                                    <div className="bg-white p-10 rounded-[40px] shadow-2xl border-2 border-dashed border-slate-200">
                                        <Icon name="image" size={64} className="text-slate-200 mb-6 mx-auto" />
                                        <h2 className="text-2xl font-bold text-slate-800 mb-2">Начните проект</h2>
                                        <p className="text-slate-400 mb-8 max-w-xs">Загрузите план этажа (PNG/JPG), чтобы расставить точки замера</p>
                                        <label className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-2xl font-bold shadow-xl cursor-pointer inline-block transition-transform hover:scale-105 active:scale-95">
                                            Выбрать файл
                                            <input type="file" className="hidden" onChange={onUpload} accept="image/*" />
                                        </label>
                                    </div>
                                </div>
                            ) : (
                                <div 
                                    ref={mapContainerRef}
                                    className="absolute origin-top-left inline-block"
                                    style={{ transform: `translate(${offset.x}px, ${offset.y}px) scale(${scale})` }}
                                >
                                    <img src={image} className="block max-w-none h-[75vh] w-auto shadow-2xl" draggable={false} />
                                    {points.map(p => (
                                        <div 
                                            key={p.id}
                                            onClick={(e) => { e.stopPropagation(); setSelectedId(p.id); }}
                                            className={`absolute -translate-x-1/2 -translate-y-1/2 flex items-center justify-center rounded-full border-2 shadow-lg transition-all ${
                                                selectedId === p.id 
                                                ? 'w-10 h-10 bg-blue-600 border-white text-white z-30 scale-110' 
                                                : 'w-8 h-8 bg-red-500 border-white text-white z-20'
                                            }`}
                                            style={{ left: `${p.x}%`, top: `${p.y}%` }}
                                        >
                                            <span className="text-[10px] font-bold">{p.id}</span>
                                            {p.dbm && (
                                                <div className="absolute top-full mt-1 bg-slate-900 text-white text-[9px] px-1.5 py-0.5 rounded font-bold whitespace-nowrap">
                                                    {p.dbm} dBm
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* Подсказки и кнопки управления */}
                            {image && (
                                <div className="absolute bottom-6 left-6 flex flex-col gap-2">
                                    <div className="bg-white/80 backdrop-blur px-4 py-2 rounded-xl text-[10px] font-bold text-slate-500 shadow-sm border border-slate-200 hidden sm:block">
                                        Тап: точка | Свайп: двигать | Зум: колесо/щипок
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setScale(s => s * 1.2)} className="w-12 h-12 bg-white rounded-2xl shadow-lg flex items-center justify-center text-slate-600 active:scale-90"><Icon name="plus" /></button>
                                        <button onClick={() => setScale(s => s * 0.8)} className="w-12 h-12 bg-white rounded-2xl shadow-lg flex items-center justify-center text-slate-600 active:scale-90"><Icon name="minus" /></button>
                                        <button onClick={() => {setScale(1); setOffset({x:0, y:0})}} className="w-12 h-12 bg-white rounded-2xl shadow-lg flex items-center justify-center text-slate-600 active:scale-90"><Icon name="maximize" /></button>
                                    </div>
                                </div>
                            )}
                        </section>

                        {/* Боковая панель */}
                        <aside className={`
                            absolute md:relative inset-y-0 right-0 w-full md:w-80 bg-white shadow-2xl z-40 flex flex-col transition-transform duration-300
                            ${isPanelOpen ? 'translate-x-0' : 'translate-x-full md:translate-x-0'}
                            ${!image ? 'hidden' : ''}
                        `}>
                            <div className="p-4 border-b flex items-center justify-between bg-slate-50/50">
                                <h3 className="font-bold text-slate-700 uppercase text-sm tracking-widest">Список замеров</h3>
                                <button onClick={() => setIsPanelOpen(false)} className="md:hidden p-2 text-slate-400"><Icon name="x" /></button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                {points.length === 0 ? (
                                    <div className="text-center py-20 text-slate-300">
                                        <Icon name="mouse-pointer-2" size={32} className="mx-auto mb-2 opacity-20" />
                                        <p className="text-xs font-bold uppercase tracking-tighter">Нажмите на план,<br/>чтобы поставить точку</p>
                                    </div>
                                ) : (
                                    [...points].reverse().map(p => (
                                        <div 
                                            key={p.id} 
                                            onClick={() => setSelectedId(p.id)} 
                                            className={`p-4 rounded-2xl border-2 transition-all cursor-pointer ${
                                                selectedId === p.id ? 'border-blue-500 bg-blue-50 shadow-sm' : 'border-slate-100 bg-white'
                                            }`}
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold text-sm shrink-0 ${
                                                    selectedId === p.id ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'
                                                }`}>
                                                    {p.id}
                                                </div>
                                                <div className="flex-1 relative">
                                                    <input 
                                                        type="number" 
                                                        className="w-full bg-transparent border-b-2 border-slate-200 focus:border-blue-400 outline-none font-bold text-xl pr-10" 
                                                        placeholder="-65"
                                                        value={p.dbm}
                                                        onChange={(e) => setPoints(points.map(pt => pt.id === p.id ? {...pt, dbm: e.target.value} : pt))}
                                                    />
                                                    <span className="absolute right-0 bottom-1.5 text-[10px] text-slate-400 font-bold uppercase">dBm</span>
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); setPoints(points.filter(pt => pt.id !== p.id)); }} className="text-slate-300 hover:text-red-500 transition-colors p-2">
                                                    <Icon name="trash-2" size={18} />
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            <div className="p-6 border-t bg-slate-50/50">
                                <button onClick={() => {if(confirm('Удалить всё?')){setImage(null); setPoints([]);}}} className="w-full py-3 text-[10px] font-black text-slate-400 hover:text-red-500 border-2 border-dashed border-slate-200 rounded-2xl transition-all uppercase tracking-widest">
                                    Очистить проект
                                </button>
                            </div>
                        </aside>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
